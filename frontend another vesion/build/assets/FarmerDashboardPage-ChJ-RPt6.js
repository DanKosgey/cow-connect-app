const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DYSULANo.js","assets/PieChart-qLQrvWxl.js","assets/index-C6fZJ48e.js","assets/index-Bojq63D2.css","assets/CartesianGrid-BVLrOhPa.js"])))=>i.map(i=>d[i]);
import{r as i,c as O,j as e,d as U,M as Q,_ as v,a as K}from"./index-C6fZJ48e.js";import{C as x,a as u,b as f,c as N,d as j}from"./card-D80GW863.js";import{B as T}from"./badge-Bb0m1QXe.js";import{B as w}from"./button-CjSaidot.js";import{u as M}from"./useWebSocket-j9kM2P_4.js";import{V as L}from"./VisuallyHidden-DcEPUErl.js";import{S as k}from"./SkeletonLoader-CbxjZ_Nk.js";import{C as V}from"./circle-alert-B7BDXU-i.js";import{R}from"./refresh-cw-BiFb2P_u.js";import{C as G}from"./circle-check-big-CorUa3eH.js";import{C as W}from"./clock-B7WW80Vs.js";import{D as H}from"./dollar-sign-ZMqYMnDH.js";import{T as Y}from"./trending-up-DypWr_bi.js";import{C as J}from"./calendar-B8DrZPNE.js";import{L as X}from"./loader-circle-tNDcm6lY.js";async function Z(r,o={}){const s=localStorage.getItem("authToken"),m={"Content-Type":"application/json",...o.headers||{}};s&&(m.Authorization=`Bearer ${s}`);const l=r.startsWith("/api/v1")?r:`/api/v1${r.startsWith("/")?r:"/"+r}`,a=await fetch(`${l}`,{...o,headers:m});let c;try{c=await a.json()}catch{try{c=await a.text()}catch{c="Unable to parse response"}}if(!a.ok){let h="Unknown error occurred";throw typeof c=="object"&&c!==null?h=c.detail||c.message||JSON.stringify(c):typeof c=="string"&&(h=c),new Error(`API ${a.status}: ${h}`)}return c}async function ee(r){var o,s,m;try{const l=await Z(`/farmers/${r}/dashboard`);return{totalCollections:l.total_collections,monthlyEarnings:l.monthly_earnings,averageQuality:l.average_quality,upcomingPayments:((o=l.upcoming_payments)==null?void 0:o.map(a=>({id:a.id,amount:a.amount,status:a.status,dueDate:a.due_date})))||[],recentCollections:((s=l.recent_collections)==null?void 0:s.map(a=>({id:a.id,volume:a.volume,quality:a.quality,timestamp:a.timestamp,pricePerLiter:a.price_per_liter})))||[],qualityTrends:((m=l.quality_trends)==null?void 0:m.map(a=>({date:a.date,quality:a.quality,volume:a.volume})))||[]}}catch(l){throw console.error("Failed to fetch farmer dashboard data:",l),new Error("Failed to load dashboard data. Please try again.")}}const se={getDashboardData:ee},te=r=>{const[o,s]=i.useState(null),[m,l]=i.useState(!0),[g,a]=i.useState(null),[c,h]=i.useState(null),p=i.useCallback(async()=>{if(r)try{l(!0),a(null);const y=await se.getDashboardData(r);s(y),h(new Date)}catch(y){a(y instanceof Error?y.message:"Failed to load dashboard data"),console.error("Error fetching dashboard data:",y)}finally{l(!1)}},[r]),_=i.useCallback(()=>{p()},[p]);return i.useEffect(()=>{p()},[p]),i.useEffect(()=>{if(!r)return;const y=setInterval(()=>{m||p()},3e5);return()=>clearInterval(y)},[r,m,p]),{dashboardData:o,loading:m,error:g,lastUpdated:c,refreshDashboard:_}},F=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.ResponsiveContainer}))),re=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.LineChart}))),ae=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.Line}))),ie=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.BarChart}))),ne=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.Bar}))),q=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.CartesianGrid}))),$=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.XAxis}))),I=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.YAxis}))),B=i.lazy(()=>v(()=>import("./index-DYSULANo.js"),__vite__mapDeps([0,1,2,3,4])).then(r=>({default:r.Tooltip}))),le=({farmerId:r})=>{var S,D,P;const{toast:o}=O(),{dashboardData:s,loading:m,error:l,refreshDashboard:g}=te(r),{ws:a,isConnected:c}=M(`/ws/farmer/${r}`),[h,p]=i.useState([]),[_,y]=i.useState([]);i.useEffect(()=>{if(!a)return;const t=d=>{try{const n=JSON.parse(d.data);if(n.type==="collection_recorded"){const C={id:n.collection_id,volume:n.volume,quality:n.quality,timestamp:n.timestamp,pricePerLiter:n.price_per_liter||0};p(E=>[C,...E.slice(0,4)]),o({title:"New Collection Recorded",description:`Collection of ${n.volume}L with ${n.quality} quality recorded`})}else if(n.type==="payment_processed"){const C={id:n.payment_id,amount:n.amount,status:n.status,dueDate:n.date};y(E=>E.map(A=>A.id===n.payment_id?C:A)),o({title:"Payment Status Updated",description:`Payment ${n.status} for KSh ${n.amount}`})}else n.type==="quality_alert"&&o({title:"Quality Alert",description:n.message,variant:n.severity==="high"?"destructive":"default"})}catch(n){console.error("Error parsing WebSocket message:",n)}};return a.addEventListener("message",t),()=>{a.removeEventListener("message",t)}},[a,o]);const z=h.length>0?[...h,...(s==null?void 0:s.recentCollections.slice(h.length))||[]]:(s==null?void 0:s.recentCollections)||[],b=_.length>0?_.map(t=>{const d=s==null?void 0:s.upcomingPayments.find(n=>n.id===t.id);return d?{...d,...t}:t}):(s==null?void 0:s.upcomingPayments)||[];return m?e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[...Array(4)].map((t,d)=>e.jsx("div",{className:"h-32 bg-gray-200 rounded-lg"},d))}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"h-80 bg-gray-200 rounded-lg"}),e.jsx("div",{className:"h-80 bg-gray-200 rounded-lg"})]}),e.jsx("div",{className:"h-64 bg-gray-200 rounded-lg"})]})})}):l?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-6",children:e.jsxs(x,{className:"w-full max-w-md",children:[e.jsxs(u,{children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-red-500"}),"Error Loading Dashboard"]}),e.jsx(N,{children:l})]}),e.jsx(j,{children:e.jsxs(w,{onClick:g,className:"w-full",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Try Again"]})})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 p-6",children:[e.jsx(U,{targetId:"main-content",children:"Skip to main content"}),e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("header",{className:"flex justify-between items-center mb-6",role:"banner",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Farmer Dashboard"}),e.jsx("p",{className:"text-gray-600",children:"Track your collections, earnings, and payments"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(T,{variant:c?"default":"destructive",className:"flex items-center gap-1",children:c?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-3 w-3","aria-hidden":"true"}),"Live Updates"]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"h-3 w-3","aria-hidden":"true"}),"Connecting..."]})}),e.jsxs(w,{onClick:g,variant:"outline","aria-label":"Refresh dashboard",children:[e.jsx(R,{className:"h-4 w-4 mr-2","aria-hidden":"true"}),"Refresh"]})]})]}),e.jsxs("main",{id:"main-content",role:"main",children:[e.jsxs("section",{"aria-labelledby":"stats-heading",children:[e.jsx(L,{as:"h2",id:"stats-heading",children:"Dashboard Statistics"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6",children:[e.jsxs(x,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Total Collections"}),e.jsx(Q,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:((S=s==null?void 0:s.totalCollections)==null?void 0:S.toLocaleString())||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+12% from last month"})]})]}),e.jsxs(x,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Monthly Earnings"}),e.jsx(H,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["KSh ",((D=s==null?void 0:s.monthlyEarnings)==null?void 0:D.toLocaleString())||0]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+8% from last month"})]})]}),e.jsxs(x,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Avg. Quality"}),e.jsx(Y,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:((P=s==null?void 0:s.averageQuality)==null?void 0:P.toFixed(1))||"0.0"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Grade ",s!=null&&s.averageQuality?s.averageQuality>=4?"A":s.averageQuality>=3?"B":"C":"N/A"]})]})]}),e.jsxs(x,{children:[e.jsxs(u,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Upcoming Payments"}),e.jsx(J,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:b.filter(t=>t.status==="pending").length}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["KSh ",b.filter(t=>t.status==="pending").reduce((t,d)=>t+d.amount,0).toLocaleString()," pending"]})]})]})]})]}),e.jsxs("section",{"aria-labelledby":"charts-heading",className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6",children:[e.jsx(L,{as:"h2",id:"charts-heading",children:"Performance Charts"}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsx(f,{children:"Quality Trends"}),e.jsx(N,{children:"Historical quality scores for your collections"})]}),e.jsx(j,{children:e.jsx("div",{className:"h-80",children:e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx(k,{type:"chart"})}),children:e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(re,{data:(s==null?void 0:s.qualityTrends)||[],margin:{top:5,right:30,left:20,bottom:5},children:[e.jsx(q,{strokeDasharray:"3 3"}),e.jsx($,{dataKey:"date",tickFormatter:t=>{const d=new Date(t);return`${d.getMonth()+1}/${d.getDate()}`}}),e.jsx(I,{}),e.jsx(B,{formatter:t=>[t,"Quality Score"],labelFormatter:t=>`Date: ${t}`}),e.jsx(ae,{type:"monotone",dataKey:"quality",stroke:"#10b981",activeDot:{r:8},name:"Quality Score"})]})})})})})]}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsx(f,{children:"Collection Volume"}),e.jsx(N,{children:"Daily collection volumes in liters"})]}),e.jsx(j,{children:e.jsx("div",{className:"h-80",children:e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx(k,{type:"chart"})}),children:e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(ie,{data:(s==null?void 0:s.qualityTrends)||[],margin:{top:5,right:30,left:20,bottom:5},children:[e.jsx(q,{strokeDasharray:"3 3"}),e.jsx($,{dataKey:"date",tickFormatter:t=>{const d=new Date(t);return`${d.getMonth()+1}/${d.getDate()}`}}),e.jsx(I,{}),e.jsx(B,{formatter:t=>[t,"Liters"],labelFormatter:t=>`Date: ${t}`}),e.jsx(ne,{dataKey:"volume",fill:"#0ea5e9",name:"Volume (L)"})]})})})})})]})]}),e.jsxs("section",{"aria-labelledby":"activity-heading",className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(L,{as:"h2",id:"activity-heading",children:"Activity"}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsx(f,{children:"Recent Collections"}),e.jsx(N,{children:"Your latest milk collections"})]}),e.jsx(j,{children:e.jsx("div",{className:"space-y-4",children:z.slice(0,5).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[t.volume,"L"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Grade ",t.quality," • ",new Date(t.timestamp).toLocaleDateString()]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-medium",children:["KSh ",(t.volume*t.pricePerLiter).toLocaleString()]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t.pricePerLiter,"/L"]})]})]},t.id))})})]}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsx(f,{children:"Upcoming Payments"}),e.jsx(N,{children:"Scheduled payments for your collections"})]}),e.jsx(j,{children:e.jsx("div",{className:"space-y-4",children:b.slice(0,5).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:["KSh ",t.amount.toLocaleString()]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Due ",new Date(t.dueDate).toLocaleDateString()]})]}),e.jsx(T,{variant:t.status==="pending"?"default":"secondary",className:t.status==="processed"?"bg-green-100 text-green-800":"",children:t.status.charAt(0).toUpperCase()+t.status.slice(1)})]},t.id))})})]})]})]})]})]})},we=()=>{const{user:r}=K(),[o,s]=i.useState(""),[m,l]=i.useState(!0),[g,a]=i.useState(null);return i.useEffect(()=>{r&&(async()=>{try{l(!0),r&&r.role==="farmer"?s(r.id):a("User is not authorized as a farmer"),l(!1)}catch{a("Failed to load farmer information"),l(!1)}})()},[r]),m?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(X,{className:"h-8 w-8 animate-spin text-green-600"}),e.jsx("p",{className:"text-gray-600",children:"Loading dashboard..."})]})}):g?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-6",children:e.jsxs(x,{className:"w-full max-w-md",children:[e.jsxs(u,{children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-red-500"}),"Error Loading Dashboard"]}),e.jsx(N,{children:g})]}),e.jsx(j,{children:e.jsx(w,{onClick:()=>window.location.reload(),className:"w-full",children:"Try Again"})})]})}):o?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx(le,{farmerId:o})}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-6",children:e.jsxs(x,{className:"w-full max-w-md",children:[e.jsxs(u,{children:[e.jsx(f,{children:"Farmer Not Found"}),e.jsx(N,{children:"No farmer profile associated with your account."})]}),e.jsx(j,{children:e.jsx(w,{onClick:()=>window.location.reload(),className:"w-full",children:"Refresh"})})]})})};export{we as default};
