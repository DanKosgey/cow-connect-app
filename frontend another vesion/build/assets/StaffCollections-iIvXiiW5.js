import{e as X,r as t,j as e,U as Y,t as R,a as he,M as Te,L as Ae,z as ae}from"./index-C6fZJ48e.js";import{C as q,d as D,a as z,b as Q,c as J}from"./card-D80GW863.js";import{B as N}from"./button-CjSaidot.js";import{I as F}from"./input-ZoKW3yZy.js";import{L as M}from"./label-Cb1HMnpx.js";import{B as O}from"./badge-Bb0m1QXe.js";import{F as Le,b as pe,a as re}from"./ApiService-bGFnA_mg.js";import{u as fe}from"./gpsValidation-lYsOLY3Q.js";import{a as oe,v as Me,b as Ee,u as Ie}from"./useCollectionSubmission-COHs5Dxr.js";import{S as ye}from"./search-CMvfZT_q.js";import{P as Be}from"./phone-dekQ5OlX.js";import{M as de}from"./map-pin-B94T8gzc.js";import{S as V}from"./scale-DPhZ4N1V.js";import{C as qe}from"./calendar-B8DrZPNE.js";import{S as De,a as Pe,b as Ge,c as He,d as ie}from"./select-CiyqlXTk.js";import{T as $e}from"./trash-2-BFdGnQiG.js";import{P as je}from"./plus-B6s2IIiO.js";import{G as ge}from"./GPSStatusIndicator-DMqfqeQN.js";import{C as ze}from"./check-wjAQzcvr.js";import{T as xe}from"./triangle-alert-DiNmet34.js";import{T as Qe}from"./thermometer-17IlW1ep.js";import{C as ne}from"./circle-check-big-CorUa3eH.js";import{S as Oe}from"./smartphone-BOKbuaXO.js";import"./index-BdQq_4o_.js";import"./index-Bmq6tP-i.js";import"./Combination-D2BFsl2-.js";import"./index-wh3HXzvH.js";import"./circle-x-rQriW1OR.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=X("List",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=X("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=X("QrCode",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=X("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),Ue=({initialQuery:o="",delay:m=300}={})=>{const[n,u]=t.useState(o),[r,i]=t.useState([]),[c,s]=t.useState(!1),[b,y]=t.useState(null),{searchFarmers:d}=oe(),a=t.useCallback(async g=>{if(!g.trim()){i([]);return}s(!0),y(null);try{const v=(await Le.list(100,0,g)).items||[];i(v)}catch(f){console.error("Online search failed, trying offline search:",f);try{const v=await d(g);i(v)}catch(v){console.error("Offline search also failed:",v),y("Failed to search farmers")}}finally{s(!1)}},[d]);return t.useEffect(()=>{const g=setTimeout(()=>{a(n)},m);return()=>{clearTimeout(g)}},[n,m,a]),{query:n,setQuery:g=>{u(g)},results:r,loading:c,error:b}},me=()=>{const[o,m]=t.useState(!1),[n,u]=t.useState(!1),[r,i]=t.useState(!1),[c,s]=t.useState(0),[b,y]=t.useState(0);return t.useEffect(()=>{const d=()=>{const a=window.innerWidth,C=window.innerHeight;s(a),y(C);const g=a<=768;m(g);const f=a>768&&a<=1024;u(f);const v="ontouchstart"in window||navigator.maxTouchPoints>0;i(v)};return d(),window.addEventListener("resize",d),window.addEventListener("orientationchange",d),()=>{window.removeEventListener("resize",d),window.removeEventListener("orientationchange",d)}},[]),{isMobile:o,isTablet:n,isTouchDevice:r,screenWidth:c,screenHeight:b}},Ye=({onFarmerSelect:o,placeholder:m="Search farmers by name, phone, ID, or location...",disabled:n=!1})=>{const{query:u,setQuery:r,results:i,loading:c,error:s}=Ue(),{addFarmer:b}=oe(),{isMobile:y}=me(),[d,a]=t.useState(!1),[C,g]=t.useState(!1);t.useRef(null);const f=t.useRef(null),v=async j=>{var _,S;o(j),a(!1),r("");try{await b({id:j.id,name:j.name,phone:j.phone,address:j.address,gpsLatitude:(_=j.location_coordinates)==null?void 0:_.latitude,gpsLongitude:(S=j.location_coordinates)==null?void 0:S.longitude,nationalId:j.national_id})}catch(T){console.error("Failed to save farmer to IndexedDB:",T)}};return t.useEffect(()=>{const j=_=>{d&&!_.target.closest(".farmer-search-container")&&a(!1)};return document.addEventListener("mousedown",j),()=>{document.removeEventListener("mousedown",j)}},[d]),e.jsxs("div",{className:"farmer-search-container relative w-full",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-dairy-400 h-4 w-4"}),e.jsx(F,{ref:f,type:"text",placeholder:m,value:u,onChange:j=>{r(j.target.value),a(!0)},onFocus:()=>{a(!0),g(!0)},onBlur:()=>g(!1),disabled:n,className:`pl-10 pr-10 py-3 w-full rounded-lg border border-dairy-300 focus:ring-2 focus:ring-dairy-blue focus:border-dairy-blue transition-all duration-200 ${y?"text-lg":""}`,...y&&{inputMode:"search",enterKeyHint:"search",autoComplete:"off"}}),C&&u&&e.jsx("button",{type:"button",className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-dairy-400 hover:text-dairy-600",onClick:()=>{r(""),a(!1)},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})})]}),d&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-dairy-200 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:[c&&e.jsx("div",{className:"p-4 text-center text-dairy-600",children:"Searching farmers..."}),s&&e.jsx("div",{className:"p-4 text-center text-red-500",children:s}),!c&&!s&&i.length===0&&u&&e.jsxs("div",{className:"p-4 text-center text-dairy-600",children:['No farmers found matching "',u,'"']}),!c&&i.length>0&&e.jsx("ul",{className:"py-1 max-h-80 overflow-y-auto",children:i.map(j=>e.jsx("li",{children:e.jsx(N,{variant:"ghost",className:`w-full justify-start px-4 py-3 h-auto text-left hover:bg-dairy-100 transition-colors duration-150 ${y?"py-4":""}`,onClick:()=>v(j),children:e.jsxs("div",{className:"flex items-center space-x-3 w-full",children:[e.jsx("div",{className:"w-10 h-10 bg-dairy-blue/10 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Y,{className:"h-5 w-5 text-dairy-blue"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:`font-medium text-dairy-900 truncate ${y?"text-base":""}`,children:j.name}),e.jsxs("div",{className:"flex items-center text-sm text-dairy-600 mt-1",children:[e.jsx(Be,{className:"h-3 w-3 mr-1 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:j.phone})]}),j.address&&e.jsxs("div",{className:"flex items-center text-sm text-dairy-600 mt-1",children:[e.jsx(de,{className:"h-3 w-3 mr-1 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:j.address})]}),e.jsx("div",{className:"flex items-center text-xs text-dairy-500 mt-1",children:e.jsxs("span",{className:"truncate",children:["KYC: ",j.kyc_status||"Not verified"]})})]}),e.jsxs("div",{className:"text-xs text-dairy-500 flex-shrink-0",children:["ID: ",j.id.substring(0,8),"..."]})]})})},j.id))})]})]})},Je=({farmerId:o})=>{const[m,n]=t.useState([]),[u,r]=t.useState(!0),[i,c]=t.useState(null);return t.useEffect(()=>{o&&(async()=>{try{r(!0);const y=(await pe.list(10,0,o)).items||[];n(y)}catch(b){console.error("Error fetching collection history:",b),c("Failed to load collection history")}finally{r(!1)}})()},[o]),u?e.jsx("div",{className:"text-center py-4 text-dairy-600",children:"Loading collection history..."}):i?e.jsx("div",{className:"text-center py-4 text-red-500",children:i}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"font-medium text-dairy-900",children:"Recent Collections"}),m.length===0?e.jsx("p",{className:"text-dairy-600 text-sm",children:"No previous collections found"}):e.jsx("div",{className:"space-y-2",children:m.map(s=>e.jsx(q,{className:"border-dairy-200",children:e.jsxs(D,{className:"p-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{className:"h-4 w-4 text-dairy-blue"}),e.jsxs("span",{className:"font-medium",children:[s.liters,"L"]})]}),e.jsxs(O,{className:s.quality_grade==="A"?"bg-dairy-green":s.quality_grade==="B"?"bg-dairy-blue":"bg-dairy-orange",children:["Grade ",s.quality_grade]})]}),e.jsxs("div",{className:"flex items-center text-xs text-dairy-600 mt-2",children:[e.jsx(qe,{className:"h-3 w-3 mr-1"}),e.jsxs("span",{children:[new Date(s.timestamp).toLocaleDateString()," at"," ",new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]}),s.gps_latitude&&s.gps_longitude&&e.jsxs("div",{className:"flex items-center text-xs text-dairy-600 mt-1",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),e.jsxs("span",{children:[s.gps_latitude.toFixed(4),", ",s.gps_longitude.toFixed(4)]})]})]})},s.id))})]})},be=t.forwardRef(({className:o,...m},n)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:n,className:R("w-full caption-bottom text-sm",o),...m})}));be.displayName="Table";const Ne=t.forwardRef(({className:o,...m},n)=>e.jsx("thead",{ref:n,className:R("[&_tr]:border-b",o),...m}));Ne.displayName="TableHeader";const ve=t.forwardRef(({className:o,...m},n)=>e.jsx("tbody",{ref:n,className:R("[&_tr:last-child]:border-0",o),...m}));ve.displayName="TableBody";const Xe=t.forwardRef(({className:o,...m},n)=>e.jsx("tfoot",{ref:n,className:R("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",o),...m}));Xe.displayName="TableFooter";const le=t.forwardRef(({className:o,...m},n)=>e.jsx("tr",{ref:n,className:R("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",o),...m}));le.displayName="TableRow";const I=t.forwardRef(({className:o,...m},n)=>e.jsx("th",{ref:n,className:R("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",o),...m}));I.displayName="TableHead";const B=t.forwardRef(({className:o,...m},n)=>e.jsx("td",{ref:n,className:R("p-4 align-middle [&:has([role=checkbox])]:pr-0",o),...m}));B.displayName="TableCell";const Ze=t.forwardRef(({className:o,...m},n)=>e.jsx("caption",{ref:n,className:R("mt-4 text-sm text-muted-foreground",o),...m}));Ze.displayName="TableCaption";const et=({farmers:o,onSubmit:m,onCancel:n})=>{const{user:u}=he(),[r,i]=t.useState([{id:"1",farmerId:"",farmerName:"",liters:"",temperature:"",qualityGrade:"A"}]),c=()=>{i([...r,{id:Date.now().toString(),farmerId:"",farmerName:"",liters:"",temperature:"",qualityGrade:"A"}])},s=d=>{r.length>1&&i(r.filter(a=>a.id!==d))},b=(d,a,C)=>{i(r.map(g=>g.id===d?{...g,[a]:C}:g))},y=async()=>{const d=r.filter(a=>a.farmerId&&a.liters&&parseFloat(a.liters)>0).map(a=>({farmer_id:a.farmerId,staff_id:(u==null?void 0:u.id)||"",liters:parseFloat(a.liters),temperature:a.temperature?parseFloat(a.temperature):null,quality_grade:a.qualityGrade,gps_latitude:0,gps_longitude:0,validation_code:`FARM-${Date.now()}`}));if(d.length>0)try{const a={collections:d,route_id:"default_route",staff_id:(u==null?void 0:u.id)||"",collected_at:new Date().toISOString()},C=await pe.createBulk(a);m(C.created_collections)}catch(a){console.error("Error submitting collections:",a)}};return e.jsxs(q,{className:"border-dairy-200",children:[e.jsx(z,{children:e.jsxs(Q,{className:"text-dairy-900 flex items-center",children:[e.jsx(V,{className:"h-5 w-5 mr-2"}),"Bulk Collection Entry"]})}),e.jsxs(D,{className:"space-y-6",children:[e.jsx("div",{className:"border border-dairy-200 rounded-lg overflow-hidden",children:e.jsxs(be,{children:[e.jsx(Ne,{children:e.jsxs(le,{className:"bg-dairy-50",children:[e.jsx(I,{className:"w-[200px]",children:"Farmer"}),e.jsx(I,{className:"w-[100px]",children:"Liters"}),e.jsx(I,{className:"w-[100px]",children:"Temperature (°C)"}),e.jsx(I,{className:"w-[100px]",children:"Quality"}),e.jsx(I,{className:"w-[50px]"})]})}),e.jsx(ve,{children:r.map(d=>e.jsxs(le,{children:[e.jsx(B,{children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("div",{className:"flex-1",children:e.jsx(F,{type:"text",placeholder:"Search farmer...",value:d.farmerName,onChange:a=>b(d.id,"farmerName",a.target.value),className:"w-full"})})})}),e.jsx(B,{children:e.jsx(F,{type:"number",placeholder:"0.0",value:d.liters,onChange:a=>b(d.id,"liters",a.target.value),className:"text-center"})}),e.jsx(B,{children:e.jsx(F,{type:"number",placeholder:"4.0",value:d.temperature,onChange:a=>b(d.id,"temperature",a.target.value),className:"text-center"})}),e.jsx(B,{children:e.jsxs(De,{value:d.qualityGrade,onValueChange:a=>b(d.id,"qualityGrade",a),children:[e.jsx(Pe,{children:e.jsx(Ge,{})}),e.jsxs(He,{children:[e.jsx(ie,{value:"A",children:"A"}),e.jsx(ie,{value:"B",children:"B"}),e.jsx(ie,{value:"C",children:"C"})]})]})}),e.jsx(B,{children:e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>s(d.id),disabled:r.length<=1,children:e.jsx($e,{className:"h-4 w-4 text-dairy-600"})})})]},d.id))})]})}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs(N,{variant:"outline",onClick:c,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Add Row"]}),e.jsxs("div",{className:"space-x-2",children:[e.jsx(N,{variant:"outline",onClick:n,children:"Cancel"}),e.jsx(N,{onClick:y,disabled:r.length===0,children:"Submit All Collections"})]})]})]})]})},ce=t.forwardRef(({className:o,legend:m,error:n,children:u,...r},i)=>e.jsxs("fieldset",{ref:i,className:R("border border-input rounded-md p-4",n&&"border-destructive",o),...r,children:[m&&e.jsx("legend",{className:"text-sm font-medium px-1",children:m}),e.jsx("div",{className:"mt-2",children:u})]}));ce.displayName="Fieldset";const tt=({onSubmit:o,onCancel:m,loading:n,farmerName:u,initialData:r={}})=>{const[i,c]=t.useState({volume:r.volume||0,temperature:r.temperature||4,fat_content:r.fat_content||void 0,protein_content:r.protein_content||void 0,location:r.location||{latitude:0,longitude:0,accuracy:0},photos:r.photos||[],notes:r.notes||""}),[s,b]=t.useState({}),[y,d]=t.useState(null),{isMobile:a}=me(),C=t.useRef(null),g=t.useRef(null),{location:f,error:v,loading:j,getLocation:_,watchPosition:S,clearWatch:T,permissionState:P}=fe({enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4}),[Z,ee]=t.useState(null),[A,h]=t.useState("acquiring"),W=()=>!f||f.accuracy===null?"acquiring":f.accuracy<5?"excellent":f.accuracy<15?"good":"poor";t.useEffect(()=>{f?(c(x=>({...x,location:{latitude:f.latitude,longitude:f.longitude,accuracy:f.accuracy||0}})),h("acquired")):v&&h("error")},[f,v]),t.useEffect(()=>{P==="denied"&&h("denied")},[P]),t.useEffect(()=>{const x=S();return ee(x),()=>{x!==null&&T(x)}},[S,T]),t.useEffect(()=>{const x=i.temperature;x>=2&&x<=4?d("optimal"):x>4&&x<=6?d("warning"):d("critical")},[i.temperature]);const K=()=>{const x={};return Me(i.volume.toString())||(x.volume="Please enter a valid quantity (0.1 - 1000 liters)"),(i.temperature<0||i.temperature>10)&&(x.temperature="Temperature must be between 0°C and 10°C"),i.fat_content!==void 0&&(i.fat_content<0||i.fat_content>20)&&(x.fat_content="Fat content must be between 0% and 20%"),i.protein_content!==void 0&&(i.protein_content<0||i.protein_content>10)&&(x.protein_content="Protein content must be between 0% and 10%"),Ee(i.location.latitude,i.location.longitude)||(x.location="Invalid GPS coordinates"),b(x),Object.keys(x).length===0},L=(x,se)=>{c(G=>({...G,[x]:se})),s[x]&&b(G=>{const U={...G};return delete U[x],U})},te=x=>{x.preventDefault(),K()&&o(i)};return e.jsxs("form",{onSubmit:te,className:"space-y-6",noValidate:!0,children:[e.jsx("div",{className:"bg-secondary-50 p-4 rounded-lg",children:e.jsxs("h3",{className:"font-medium text-secondary-900",children:["Recording collection for: ",u]})}),e.jsxs(ce,{legend:"Collection Details",className:"grid grid-cols-1 md:grid-cols-2 gap-lg",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"volume",children:"Milk Volume (Liters) *"}),e.jsx(F,{ref:C,id:"volume",type:"number",step:"0.1",min:"0.1",max:"1000",placeholder:"0.0",className:`text-lg text-center ${s.volume?"border-red-500":""} ${a?"text-xl py-3":""}`,value:i.volume||"",onChange:x=>L("volume",parseFloat(x.target.value)||0),...a&&{inputMode:"decimal",enterKeyHint:"next",autoFocus:!0},"aria-invalid":!!s.volume,"aria-describedby":s.volume?"volume-error":void 0}),s.volume&&e.jsx("p",{id:"volume-error",className:"text-red-500 text-sm mt-xs",role:"alert",children:s.volume}),e.jsxs(N,{variant:"outline",className:"w-full mt-sm",type:"button","aria-label":"Auto-weigh milk",children:[e.jsx(V,{className:"h-4 w-4 mr-2","aria-hidden":"true"}),"Auto-Weigh"]})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"temperature",children:"Temperature (°C) *"}),e.jsxs("div",{className:"relative",children:[e.jsx(F,{ref:g,id:"temperature",type:"number",step:"0.1",min:"0",max:"10",placeholder:"4.0",className:`text-lg text-center pr-10 ${s.temperature?"border-red-500":y==="optimal"?"border-primary-500":y==="warning"?"border-warning":y==="critical"?"border-error":""} ${a?"text-xl py-3":""}`,value:i.temperature||"",onChange:x=>L("temperature",parseFloat(x.target.value)||0),...a&&{inputMode:"decimal",enterKeyHint:"next"},"aria-invalid":!!s.temperature,"aria-describedby":s.temperature?"temperature-error":void 0}),e.jsxs("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:[y==="optimal"&&e.jsx(ze,{className:"h-5 w-5 text-primary-500","aria-hidden":"true"}),y==="warning"&&e.jsx(xe,{className:"h-5 w-5 text-warning","aria-hidden":"true"}),y==="critical"&&e.jsx(xe,{className:"h-5 w-5 text-error","aria-hidden":"true"})]})]}),s.temperature&&e.jsx("p",{id:"temperature-error",className:"text-red-500 text-sm mt-xs",role:"alert",children:s.temperature}),e.jsxs("div",{className:"flex items-center mt-xs",children:[e.jsx(Qe,{className:"h-4 w-4 mr-1 text-secondary-600","aria-hidden":"true"}),e.jsx("span",{className:"text-xs text-secondary-600",children:y==="optimal"?"Optimal: 2-4°C":y==="warning"?"Acceptable: 4-6°C":y==="critical"?"Critical: Outside 2-6°C":"Optimal: 2-4°C"})]})]})]}),e.jsxs(ce,{legend:"Quality Parameters",className:"grid grid-cols-1 md:grid-cols-2 gap-lg",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"fatContent",children:"Fat Content (%)"}),e.jsx(F,{id:"fatContent",type:"number",step:"0.1",min:"0",max:"20",placeholder:"4.0",className:`text-lg text-center ${s.fat_content?"border-red-500":""} ${a?"text-xl py-3":""}`,value:i.fat_content||"",onChange:x=>L("fat_content",parseFloat(x.target.value)||void 0),...a&&{inputMode:"decimal",enterKeyHint:"next"},"aria-invalid":!!s.fat_content,"aria-describedby":s.fat_content?"fat-content-error":void 0}),s.fat_content&&e.jsx("p",{id:"fat-content-error",className:"text-red-500 text-sm mt-xs",role:"alert",children:s.fat_content}),e.jsx("p",{className:"text-xs text-secondary-600 mt-xs",children:"Optimal: 3.5-4.5%"})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"proteinContent",children:"Protein Content (%)"}),e.jsx(F,{id:"proteinContent",type:"number",step:"0.1",min:"0",max:"10",placeholder:"3.2",className:`text-lg text-center ${s.protein_content?"border-red-500":""} ${a?"text-xl py-3":""}`,value:i.protein_content||"",onChange:x=>L("protein_content",parseFloat(x.target.value)||void 0),...a&&{inputMode:"decimal",enterKeyHint:"done"},"aria-invalid":!!s.protein_content,"aria-describedby":s.protein_content?"protein-content-error":void 0}),s.protein_content&&e.jsx("p",{id:"protein-content-error",className:"text-red-500 text-sm mt-xs",role:"alert",children:s.protein_content}),e.jsx("p",{className:"text-xs text-secondary-600 mt-xs",children:"Optimal: 3.0-3.5%"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx(M,{children:"Collection Location"}),e.jsx(N,{variant:"outline",size:"sm",type:"button",onClick:_,disabled:j,className:"flex items-center","aria-label":j?"Refreshing location...":"Refresh location",children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"Refreshing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-4 w-4 mr-1","aria-hidden":"true"}),"Refresh"]})})]}),e.jsx(ge,{status:A==="acquired"?W():A==="denied"?"denied":A==="error"?"error":"acquiring",accuracy:f==null?void 0:f.accuracy,latitude:f==null?void 0:f.latitude,longitude:f==null?void 0:f.longitude,onRefresh:_,onRequestPermission:_}),s.location&&e.jsx("p",{id:"location-error",className:"text-red-500 text-sm mt-xs",role:"alert",children:s.location}),e.jsx("p",{className:"text-xs text-secondary-600 mt-sm",children:"Location is automatically captured and continuously updated for accuracy. High precision is required for dairy collection records."})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"notes",children:"Notes (Optional)"}),e.jsx(F,{id:"notes",placeholder:"Any additional observations...",value:i.notes||"",onChange:x=>L("notes",x.target.value),"aria-describedby":"notes-help"}),e.jsx("p",{id:"notes-help",className:"text-xs text-secondary-600 mt-xs",children:"Include any additional observations about the collection"})]}),e.jsxs("div",{className:`flex ${a?"flex-col space-y-lg":"space-x-lg"}`,children:[e.jsx(N,{type:"submit",className:`flex-1 bg-secondary-600 hover:bg-secondary-700 ${a?"py-4 text-lg":""}`,disabled:n,"aria-label":n?"Recording collection...":"Record collection",children:n?"Recording...":"Record Collection"}),e.jsx(N,{type:"button",variant:"outline",className:`flex-1 ${a?"py-4 text-lg":""}`,onClick:m,disabled:n,"aria-label":"Cancel collection recording",children:"Cancel"})]})]})},st=({farmerName:o,volume:m,qualityGrade:n,temperature:u,fatContent:r,proteinContent:i,validationCode:c,onNewCollection:s,onViewReport:b})=>{const y=d=>{switch(d){case"A":return"bg-primary-500";case"B":return"bg-warning";case"C":return"bg-orange-500";case"D":return"bg-error";case"F":return"bg-error";default:return"bg-gray-500"}};return e.jsxs(q,{className:"border-primary-200",children:[e.jsxs(z,{children:[e.jsxs(Q,{className:"text-primary-900 flex items-center",children:[e.jsx(ne,{className:"h-5 w-5 mr-2 text-primary-600"}),"Collection Recorded Successfully"]}),e.jsx(J,{children:"Collection details and validation information"})]}),e.jsxs(D,{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ne,{className:"h-8 w-8 text-primary-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-primary-900 mb-2",children:"Collection Successfully Recorded"}),e.jsx("p",{className:"text-primary-700",children:"The transaction has been verified and recorded."})]}),e.jsxs("div",{className:"bg-primary-50 p-4 rounded-lg border border-primary-200",children:[e.jsx("h4",{className:"font-medium text-primary-900 mb-2",children:"Validation Code"}),e.jsxs("div",{className:"flex items-center justify-between bg-white p-3 rounded border",children:[e.jsx("span",{className:"font-mono text-lg font-bold text-primary-800",children:c}),e.jsxs(N,{variant:"outline",size:"sm",className:"border-primary-300 text-primary-700",children:[e.jsx(We,{className:"h-4 w-4 mr-1"}),"Print"]})]}),e.jsx("p",{className:"text-xs text-primary-600 mt-2",children:"This code confirms the authenticity of this collection. Farmer should keep this for their records."})]}),e.jsxs("div",{className:"border border-primary-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-primary-900 mb-3",children:"Collection Summary:"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-primary-700",children:"Farmer:"}),e.jsx("span",{className:"text-primary-900 font-medium",children:o})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-primary-700",children:"Volume:"}),e.jsxs("span",{className:"text-primary-900 font-medium",children:[m,"L"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-green-700",children:"Quality:"}),e.jsxs(O,{className:y(n),children:["Grade ",n]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-primary-700",children:"Temperature:"}),e.jsxs("span",{className:"text-primary-900 font-medium",children:[u,"°C"]})]}),r&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-primary-700",children:"Fat Content:"}),e.jsxs("span",{className:"text-primary-900 font-medium",children:[r,"%"]})]}),i&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-primary-700",children:"Protein Content:"}),e.jsxs("span",{className:"text-primary-900 font-medium",children:[i,"%"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-primary-700",children:"Time:"}),e.jsx("span",{className:"text-primary-900 font-medium",children:new Date().toLocaleString()})]})]})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx(N,{className:"flex-1 bg-primary-600 hover:bg-primary-700",onClick:s,children:"Record Another Collection"}),e.jsxs(N,{variant:"outline",className:"flex-1 border-primary-300 text-primary-700",onClick:b,children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"Share Report"]})]})]})]})},At=()=>{const{user:o}=he(),{isMobile:m}=me(),[n,u]=t.useState(1),[r,i]=t.useState(null),[c,s]=t.useState({liters:"",temperature:"",validationCode:"",notes:"",fatContent:"",proteinContent:""}),[b,y]=t.useState([]),[d,a]=t.useState(!0),[C,g]=t.useState(null),[f,v]=t.useState(!1),[j,_]=t.useState([]),[S,T]=t.useState("A"),[P,Z]=t.useState(null),[ee,A]=t.useState(null),{location:h,error:W,getLocation:K,permissionState:L}=fe({enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4}),te=()=>!h||h.accuracy===null?"acquiring":h.accuracy<5?"excellent":h.accuracy<15?"good":"poor",{submitCollection:x,loading:se}=Ie(re),{isInitialized:G,addCollection:U}=oe(),we=(l,p,w)=>{let k="A",E="";if(l!==null&&(l>=2&&l<=4?(A("optimal"),E+="Temperature is optimal for Grade A milk. "):l>4&&l<=6?(A("warning"),k="B",E+="Temperature is acceptable but not optimal. "):(A("critical"),k=l>6?"C":"B",E+="Temperature is outside optimal range. ")),p!==null&&w!==null){let H=0,$=0;p>=3.5&&p<=4.5?H=2:p>=3&&p<=5?H=1:H=0,w>=3&&w<=3.5?$=2:w>=2.8&&w<=3.8?$=1:$=0,H===0||$===0?k==="A"?(k="B",E+="Nutritional content is below optimal. "):k==="B"&&(k="C",E+="Nutritional content is poor. "):H===2&&$===2&&k==="B"&&ee==="optimal"&&(k="A",E+="Excellent nutritional content. ")}T(k),Z(E.trim())};t.useEffect(()=>{const l=c.temperature?parseFloat(c.temperature):null,p=c.fatContent?parseFloat(c.fatContent):null,w=c.proteinContent?parseFloat(c.proteinContent):null;we(l,p,w)},[c.temperature,c.fatContent,c.proteinContent]),t.useEffect(()=>{(async()=>{try{a(!0);const w=(await re.Farmers.list(100,0)).items||[];y(w),ae.info("Farmers data fetched successfully")}catch(p){ae.error("Error fetching farmers data",p),g("Failed to load farmers data")}finally{a(!1)}})()},[]);const Ce=()=>{const l=b.find(p=>p.kyc_status==="approved");l&&(i(l),u(2))},Se=l=>{i(l),u(2)},ke=()=>{u(3)},Fe=()=>`FARM-${Date.now()}`,_e=async()=>{if(!r||!o)return;const l=await x({farmerId:r.id,farmerName:r.name,staffId:o.id,liters:parseFloat(c.liters),gpsLatitude:(h==null?void 0:h.latitude)||0,gpsLongitude:(h==null?void 0:h.longitude)||0,temperature:parseFloat(c.temperature),fatContent:c.fatContent?parseFloat(c.fatContent):void 0,proteinContent:c.proteinContent?parseFloat(c.proteinContent):void 0,notes:c.notes});l.success?u(4):g(l.error||"Failed to submit collection")},Re=async l=>{try{if(console.log("Bulk collections to submit:",l),G)for(const p of l)try{await U({id:`offline-${Date.now()}-${p.farmer_id}`,farmerId:p.farmer_id,farmerName:p.farmerName||"Unknown",staffId:p.staff_id,liters:p.liters,gpsLatitude:(h==null?void 0:h.latitude)||0,gpsLongitude:(h==null?void 0:h.longitude)||0,validationCode:p.validation_code,qualityGrade:p.quality_grade,temperature:p.temperature,fatContent:p.fat_content,proteinContent:p.protein_content,timestamp:new Date().toISOString(),synced:!1})}catch(w){console.error("Failed to save bulk collection to IndexedDB:",w)}for(const p of l)try{await re.Collections.create(p)}catch(w){console.error("Failed to submit collection:",w)}v(!1),u(4)}catch(p){ae.error("Error submitting bulk collections",p),g("Failed to submit bulk collections")}};return d?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-dairy-blue"})}):C?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsxs("div",{className:"text-red-500 text-center",children:[e.jsxs("p",{children:["Error loading data: ",C]}),e.jsx(N,{onClick:()=>window.location.reload(),className:"mt-4",children:"Retry"})]})}):e.jsxs("div",{className:"min-h-screen bg-dairy-50",children:[e.jsx("header",{className:"bg-white border-b border-dairy-200",children:e.jsx("div",{className:"container mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-dairy-blue to-dairy-green rounded-lg flex items-center justify-center",children:e.jsx(Te,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-dairy-900",children:"Staff Collection Portal"}),e.jsx("p",{className:"text-sm text-dairy-600",children:"Record milk collections with verification"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(O,{className:"bg-dairy-green",children:["Staff: ",(o==null?void 0:o.full_name)||(o==null?void 0:o.username)||"Unknown"]}),e.jsx(Ae,{to:"/",children:e.jsx(N,{variant:"outline",children:"Home"})})]})]})})}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[(h||W||L==="denied")&&e.jsx("div",{className:"mb-6",children:e.jsx(ge,{status:L==="denied"?"denied":W?"error":h?te():"acquiring",accuracy:h==null?void 0:h.accuracy,latitude:h==null?void 0:h.latitude,longitude:h==null?void 0:h.longitude,onRefresh:K,onRequestPermission:K})}),e.jsx("div",{className:"flex items-center justify-center mb-8",children:e.jsx("div",{className:"flex items-center space-x-4",children:[{num:1,icon:ue,label:"Scan"},{num:2,icon:Y,label:"Verify"},{num:3,icon:V,label:"Weigh"},{num:4,icon:ne,label:"Submit"}].map((l,p)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:`w-12 h-12 rounded-full flex flex-col items-center justify-center text-xs font-medium ${n>=l.num?"bg-dairy-blue text-white":"bg-dairy-200 text-dairy-600"}`,children:[e.jsx(l.icon,{className:"h-4 w-4"}),e.jsx("span",{className:"mt-1",children:l.label})]}),p<3&&e.jsx("div",{className:`w-12 h-1 mx-2 ${n>l.num?"bg-dairy-blue":"bg-dairy-200"}`})]},l.num))})}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsx("div",{className:"flex justify-end mb-4",children:e.jsx(N,{variant:"outline",onClick:()=>v(!f),className:`flex items-center ${m?"py-3 text-base":""}`,children:f?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Single Entry"]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Bulk Entry"]})})}),f?e.jsx(et,{farmers:b,onSubmit:Re,onCancel:()=>v(!1)}):e.jsxs(e.Fragment,{children:[n===1&&e.jsxs(q,{className:"border-dairy-200",children:[e.jsxs(z,{children:[e.jsxs(Q,{className:"text-dairy-900 flex items-center",children:[e.jsx(ye,{className:"h-5 w-5 mr-2"}),"Select Farmer"]}),e.jsx(J,{children:"Search for a farmer by name, phone, ID, or location"})]}),e.jsxs(D,{className:"space-y-6",children:[e.jsx(Ye,{onFarmerSelect:Se}),e.jsxs("div",{className:"border-t border-dairy-200 pt-6",children:[e.jsx("h3",{className:"font-medium text-dairy-900 mb-3",children:"Alternative Methods:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(N,{variant:"outline",className:"border-dairy-300",onClick:Ce,children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"QR Scan"]}),e.jsxs(N,{variant:"outline",className:"border-dairy-300",children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"NFC Tap"]})]})]})]})]}),n===2&&r&&e.jsxs(q,{className:"border-dairy-200",children:[e.jsxs(z,{children:[e.jsxs(Q,{className:"text-dairy-900 flex items-center",children:[e.jsx(Y,{className:"h-5 w-5 mr-2"}),"Verify Farmer Identity"]}),e.jsx(J,{children:"Confirm farmer details and daily validation"})]}),e.jsxs(D,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 bg-dairy-blue/10 rounded-full flex items-center justify-center",children:e.jsx(Y,{className:"h-8 w-8 text-dairy-blue"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-dairy-900",children:r.name}),e.jsx("p",{className:"text-dairy-600",children:r.phone}),e.jsx(O,{className:"bg-dairy-green mt-1",children:"KYC Approved"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-dairy-600",children:"Farmer ID:"}),e.jsx("p",{className:"font-mono text-dairy-900",children:r.id})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dairy-600",children:"Card Status:"}),e.jsx("p",{className:"text-dairy-900",children:"Active"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dairy-600",children:"Last Collection:"}),e.jsx("p",{className:"text-dairy-900",children:"Yesterday"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dairy-600",children:"Average Quality:"}),e.jsx("p",{className:"text-dairy-900",children:"Grade A"})]})]}),e.jsxs("div",{className:"bg-dairy-100 p-4 rounded-lg",children:[e.jsx(M,{htmlFor:"validationCode",children:"Daily Validation Code"}),e.jsxs("div",{className:"flex space-x-3 mt-2",children:[e.jsx(F,{id:"validationCode",placeholder:"Enter 6-digit code or auto-generate",className:"font-mono text-center text-lg",maxLength:20,value:c.validationCode,onChange:l=>s({...c,validationCode:l.target.value})}),e.jsx(N,{variant:"outline",onClick:()=>s({...c,validationCode:Fe()}),children:"Auto"})]}),e.jsx("p",{className:"text-xs text-dairy-600 mt-2",children:"Farmer should provide today's validation code from SMS or use auto-generated code"})]}),e.jsx(N,{className:"w-full bg-dairy-green hover:bg-dairy-green/90",onClick:ke,children:"Proceed to Weighing"})]})]}),n===3&&r&&e.jsxs(q,{className:"border-dairy-200",children:[e.jsxs(z,{children:[e.jsxs(Q,{className:"text-dairy-900 flex items-center",children:[e.jsx(V,{className:"h-5 w-5 mr-2"}),"Record Collection"]}),e.jsx(J,{children:"Weigh milk and capture verification photo"})]}),e.jsxs(D,{className:"space-y-6",children:[e.jsx(tt,{onSubmit:l=>{var w,k;const p={liters:l.volume.toString(),temperature:l.temperature.toString(),fatContent:((w=l.fat_content)==null?void 0:w.toString())||"",proteinContent:((k=l.protein_content)==null?void 0:k.toString())||"",notes:l.notes||"",validationCode:c.validationCode};s(p),_e()},onCancel:()=>u(2),loading:se,farmerName:r.name}),e.jsx("div",{className:"bg-dairy-50 p-4 rounded-lg",children:e.jsx(Je,{farmerId:r.id})}),e.jsxs("div",{className:"bg-dairy-100 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-dairy-900 mb-2",children:"Quality Assessment:"}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Auto-calculated Grade:"}),e.jsxs(O,{className:S==="A"?"bg-green-500":S==="B"?"bg-yellow-500":"bg-red-500",children:["Grade ",S]})]}),P&&e.jsx("p",{className:"text-xs text-dairy-600 mt-1",children:P})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx(M,{className:"text-sm",children:"Override Quality Grade:"}),e.jsx("div",{className:"flex space-x-2 mt-2",children:["A","B","C","D","F"].map(l=>e.jsxs(N,{size:"sm",variant:S===l?"default":"outline",className:S===l?l==="A"?"bg-green-500 hover:bg-green-600":l==="B"?"bg-yellow-500 hover:bg-yellow-600":"bg-red-500 hover:bg-red-600":"",onClick:()=>T(l),children:["Grade ",l]},l))})]})]})]})]}),n===4&&r&&e.jsx(st,{farmerName:r.name,volume:c.liters,qualityGrade:S,temperature:c.temperature,fatContent:c.fatContent,proteinContent:c.proteinContent,validationCode:c.validationCode,onNewCollection:()=>{u(1),i(null),s({liters:"",temperature:"",validationCode:"",notes:"",fatContent:"",proteinContent:""}),T("A"),Z(null),A(null)},onViewReport:()=>{console.log("View report clicked")}})]})]})]})]})};export{At as default};
