import{r,j as e,M as $,U as Q,z as T}from"./index-C6fZJ48e.js";import{C as _,a as D,b as L,d as C,c as Y}from"./card-D80GW863.js";import{B as z}from"./badge-Bb0m1QXe.js";import{B as f}from"./button-CjSaidot.js";import{I as J}from"./input-ZoKW3yZy.js";import{S as U,a as V,b as H,c as O,d as N}from"./select-CiyqlXTk.js";import{A as Z}from"./AdminSidebar-BlxC4_lF.js";import{S as K,m as ee}from"./avatar-BmR-I4hu.js";import{a as se}from"./ApiService-bGFnA_mg.js";import{u as te}from"./useWebSocket-j9kM2P_4.js";import{W as ae,a as re}from"./wifi-CU9CpL8x.js";import{T as ie}from"./trending-up-DypWr_bi.js";import{S as le}from"./search-CMvfZT_q.js";import{C as de}from"./clock-B7WW80Vs.js";import{M as ce}from"./map-pin-B94T8gzc.js";import{C as ne}from"./camera-CKo63GeG.js";import"./index-BdQq_4o_.js";import"./index-Bmq6tP-i.js";import"./Combination-D2BFsl2-.js";import"./index-wh3HXzvH.js";import"./check-wjAQzcvr.js";import"./sheet-hMc6SWc2.js";import"./index-CrhFojRB.js";import"./bot-CkBzqiOK.js";import"./dollar-sign-ZMqYMnDH.js";import"./chart-column-hY8aCTYj.js";import"./separator-DKBG6nYm.js";const oe=({onNewCollection:m,onKycStatusUpdate:j,onNewFarmer:c,onNewStaff:u,onConnectionChange:n})=>{const[I,P]=r.useState([]),[M,E]=r.useState([]),[q,W]=r.useState([]),[B,v]=r.useState(!0),[k,b]=r.useState(null),A=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.hostname}:8000/ws/admin`,{isConnected:y,error:w,sendMessage:l}=te(A,{onOpen:()=>{console.log("Connected to admin notifications"),v(!1),n==null||n(!0)},onClose:()=>{console.log("Disconnected from admin notifications"),n==null||n(!1)},onError:t=>{console.error("Admin WebSocket error:",t),b("Failed to connect to admin notifications"),n==null||n(!1)},onMessage:t=>{g(t)}}),g=r.useCallback(t=>{switch(console.log("Received admin notification:",t),t.event_type){case"new_collection":if(t.data&&typeof t.data=="object"){const d={id:t.data.collection_id,farmerId:t.data.farmer_id,farmerName:"",staffId:"",staffName:"",liters:t.data.liters,geoPoint:{lat:0,lng:0},photoUrl:"",timestamp:t.data.timestamp,txHash:"",validationCode:t.data.validation_code,qualityGrade:"A",temperature:0,fatContent:0,proteinContent:0};P(x=>[d,...x]),m==null||m(d)}break;case"kyc_status_update":if(t.data&&typeof t.data=="object"){const d=t.data.farmer_id||"",x=t.data.new_status||"";j==null||j(d,x)}break;case"new_farmer":if(t.data&&typeof t.data=="object"){const d={id:t.data.id,name:t.data.name,phone:t.data.phone,email:t.data.email,address:t.data.address,nationalId:t.data.national_id,kycStatus:t.data.kyc_status,registeredAt:t.data.registered_at};E(x=>[d,...x]),c==null||c(d)}break;case"new_staff":if(t.data&&typeof t.data=="object"){const d={id:t.data.id,name:t.data.name,phone:t.data.phone,email:t.data.email,role:t.data.role,isActive:t.data.is_active,lastActiveAt:t.data.last_active_at};W(x=>[d,...x]),u==null||u(d)}break;case"connected":console.log("Successfully connected to admin notifications");break;case"heartbeat":break;default:console.log("Unknown admin event type:",t.event_type)}},[m,j,c,u]),p=r.useCallback(t=>{l(t)},[l]);return r.useEffect(()=>{w&&b("Admin WebSocket connection error")},[w]),{collections:I,farmers:M,staff:q,isConnected:y,isLoading:B,error:k,sendNotification:p}},Be=()=>{const[m,j]=r.useState([]),[c,u]=r.useState([]),[n,I]=r.useState([]),[P,M]=r.useState(!0),[E,q]=r.useState(null),[W,B]=r.useState("connecting"),[v,k]=r.useState(""),[b,A]=r.useState("all"),[y,w]=r.useState("all"),[l,g]=r.useState(1),[p]=r.useState(10),{collections:t,isConnected:d,isLoading:x}=oe({onNewCollection:s=>{j(a=>[s,...a]),T.info(`New collection received via WebSocket: ${s.liters}L from farmer ${s.farmer_id}`)},onKycStatusUpdate:(s,a)=>{T.info(`KYC status updated for farmer ${s}: ${a}`)},onConnectionChange:s=>{B(s?"connected":"disconnected")}}),R=r.useCallback((s,a)=>{const i=new Set(s.map(h=>h.id));return[...a.filter(h=>!i.has(h.id)),...s]},[]);r.useEffect(()=>{(async()=>{try{M(!0);const i=(await se.Collections.list(100,0)).items;j(i),u(i),T.info("Collections data fetched successfully")}catch(a){T.error("Error fetching collections data",a),q("Failed to load collections data")}finally{M(!1)}})()},[]),r.useEffect(()=>{if(t.length>0){const s=R(m,t);j(s),u(s)}},[t,R,m]),r.useEffect(()=>{let s=[...m];if(v){const a=v.toLowerCase();s=s.filter(i=>i.farmer_name&&i.farmer_name.toLowerCase().includes(a)||i.staff_name&&i.staff_name.toLowerCase().includes(a)||i.validation_code&&i.validation_code.toLowerCase().includes(a))}if(b!=="all"&&(s=s.filter(a=>a.quality_grade===b)),y!=="all"){const a=new Date;s=s.filter(i=>{const F=new Date(i.timestamp);if(y==="today")return F.toDateString()===a.toDateString();if(y==="week"){const h=new Date(a);return h.setDate(a.getDate()-7),F>=h}else if(y==="month"){const h=new Date(a);return h.setMonth(a.getMonth()-1),F>=h}return!0})}u(s),g(1)},[m,v,b,y]),r.useEffect(()=>{const s=(l-1)*p,a=s+p;I(c.slice(s,a))},[c,l,p]);const o=Math.ceil(c.length/p),S=c.filter(s=>new Date(s.timestamp).toDateString()===new Date().toDateString()),X=S.reduce((s,a)=>s+a.liters,0),G=S.length>0?S.reduce((s,a)=>s+(a.quality_grade==="A"?3:a.quality_grade==="B"?2:1),0)/S.length:0;return P||x?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-dairy-blue"})}):E?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsxs("div",{className:"text-red-500 text-center",children:[e.jsxs("p",{children:["Error loading collections: ",E]}),e.jsx(f,{onClick:()=>window.location.reload(),className:"mt-4",children:"Retry"})]})}):e.jsx(K,{children:e.jsxs("div",{className:"min-h-screen flex w-full bg-dairy-50",children:[e.jsx(Z,{}),e.jsxs("main",{className:"flex-1 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(ee,{className:"border border-dairy-200"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-dairy-900",children:"Milk Collections"}),e.jsx("p",{className:"text-dairy-600",children:"Monitor and manage daily milk collection records"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(z,{className:`${d?"bg-green-100 text-green-700 border-green-200":"bg-red-100 text-red-700 border-red-200"}`,children:d?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),"Live Updates"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),"Connecting..."]})}),e.jsx("div",{className:"flex space-x-2",children:e.jsx(f,{className:"bg-dairy-blue hover:bg-dairy-blue/90",children:"Export Report"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsxs(_,{className:"border-dairy-200",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium text-dairy-700",children:"Today's Collections"}),e.jsx($,{className:"h-4 w-4 text-dairy-green"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold text-dairy-900",children:S.length}),e.jsx("p",{className:"text-xs text-dairy-600",children:"Collection records"})]})]}),e.jsxs(_,{className:"border-dairy-200",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium text-dairy-700",children:"Total Liters"}),e.jsx(ie,{className:"h-4 w-4 text-dairy-blue"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold text-dairy-900",children:[X,"L"]}),e.jsx("p",{className:"text-xs text-dairy-600",children:"Collected today"})]})]}),e.jsxs(_,{className:"border-dairy-200",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium text-dairy-700",children:"Average Quality"}),e.jsxs(z,{className:"bg-dairy-green/10 text-dairy-green border-dairy-green/20",children:["Grade ",G>=2.5?"A":G>=1.5?"B":"C"]})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold text-dairy-900",children:[G.toFixed(1),"/3.0"]}),e.jsx("p",{className:"text-xs text-dairy-600",children:"Quality score"})]})]}),e.jsxs(_,{className:"border-dairy-200",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(L,{className:"text-sm font-medium text-dairy-700",children:"Active Farmers"}),e.jsx(Q,{className:"h-4 w-4 text-dairy-amber"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold text-dairy-900",children:new Set(S.map(s=>s.farmer_id)).size}),e.jsx("p",{className:"text-xs text-dairy-600",children:"Delivered today"})]})]})]}),e.jsx(_,{className:"border-dairy-200 mb-6",children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-dairy-400 h-4 w-4"}),e.jsx(J,{type:"text",placeholder:"Search farmer, staff, or code...",className:"pl-10",value:v,onChange:s=>k(s.target.value)})]}),e.jsxs(U,{value:b,onValueChange:A,children:[e.jsx(V,{children:e.jsx(H,{placeholder:"Quality Grade"})}),e.jsxs(O,{children:[e.jsx(N,{value:"all",children:"All Grades"}),e.jsx(N,{value:"A",children:"Grade A"}),e.jsx(N,{value:"B",children:"Grade B"}),e.jsx(N,{value:"C",children:"Grade C"})]})]}),e.jsxs(U,{value:y,onValueChange:w,children:[e.jsx(V,{children:e.jsx(H,{placeholder:"Date Range"})}),e.jsxs(O,{children:[e.jsx(N,{value:"all",children:"All Dates"}),e.jsx(N,{value:"today",children:"Today"}),e.jsx(N,{value:"week",children:"Last 7 Days"}),e.jsx(N,{value:"month",children:"Last 30 Days"})]})]}),e.jsx("div",{className:"flex space-x-2",children:e.jsx(f,{variant:"outline",className:"border-dairy-300",onClick:()=>{k(""),A("all"),w("all")},children:"Clear Filters"})})]})})}),e.jsxs(_,{className:"border-dairy-200",children:[e.jsxs(D,{children:[e.jsx(L,{className:"text-dairy-900",children:"Collection Records"}),e.jsxs(Y,{children:[c.length," records found"]})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"space-y-4",children:[n.map(s=>e.jsxs("div",{className:"border border-dairy-200 rounded-lg p-4 hover:bg-dairy-50 transition-colors",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-dairy-blue/10 rounded-full flex items-center justify-center",children:e.jsx($,{className:"h-5 w-5 text-dairy-blue"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-dairy-900",children:s.farmer_name||"Unknown Farmer"}),e.jsxs("p",{className:"text-sm text-dairy-600",children:[s.liters,"L collected"]})]})]}),e.jsxs(z,{className:s.quality_grade==="A"?"bg-green-100 text-green-800 border-green-200":s.quality_grade==="B"?"bg-yellow-100 text-yellow-800 border-yellow-200":"bg-red-100 text-red-800 border-red-200",children:["Grade ",s.quality_grade]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(Q,{className:"h-4 w-4 text-dairy-600"}),e.jsxs("span",{className:"text-dairy-700",children:["Staff: ",s.staff_name||"Unknown Staff"]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(de,{className:"h-4 w-4 text-dairy-600"}),e.jsx("span",{className:"text-dairy-700",children:new Date(s.timestamp).toLocaleString()})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(ce,{className:"h-4 w-4 text-dairy-600"}),e.jsxs("span",{className:"text-dairy-700",children:[s.gps_latitude.toFixed(4),", ",s.gps_longitude.toFixed(4)]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(ne,{className:"h-4 w-4 text-dairy-600"}),e.jsx("span",{className:"text-dairy-700",children:"Photo verified"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"text-dairy-600",children:["Temperature: ",e.jsxs("span",{className:"text-dairy-900",children:[s.temperature,"°C"]})]}),e.jsxs("p",{className:"text-dairy-600",children:["Fat: ",e.jsxs("span",{className:"text-dairy-900",children:[s.fat_content||"N/A","%"]})]}),e.jsxs("p",{className:"text-dairy-600",children:["Protein: ",e.jsxs("span",{className:"text-dairy-900",children:[s.protein_content||"N/A","%"]})]})]}),e.jsx(f,{size:"sm",variant:"outline",className:"border-dairy-300",children:"View Details"})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-dairy-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-dairy-600",children:["Blockchain TX: ",e.jsx("span",{className:"font-mono",children:s.tx_hash?`${s.tx_hash.substring(0,10)}...`:"N/A"})]}),e.jsxs("div",{className:"text-xs text-dairy-600",children:["Validation Code: ",e.jsx("span",{className:"font-mono",children:s.validation_code||"N/A"})]})]})})]},s.id)),n.length===0&&e.jsxs("div",{className:"text-center py-8 text-dairy-600",children:[e.jsx($,{className:"h-12 w-12 mx-auto text-dairy-300 mb-2"}),e.jsx("p",{children:"No collections found matching your filters"}),e.jsx(f,{variant:"outline",className:"mt-2 border-dairy-300",onClick:()=>{k(""),A("all"),w("all")},children:"Clear Filters"})]})]}),o>1&&e.jsxs("div",{className:"flex items-center justify-between border-t border-dairy-200 pt-4 mt-4",children:[e.jsxs("div",{className:"text-sm text-dairy-600",children:["Showing ",(l-1)*p+1," to ",Math.min(l*p,c.length)," of ",c.length," results"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(f,{variant:"outline",size:"sm",className:"border-dairy-300",onClick:()=>g(s=>Math.max(s-1,1)),disabled:l===1,children:"Previous"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[Array.from({length:Math.min(5,o)},(s,a)=>{const i=a+1;return e.jsx(f,{variant:l===i?"default":"outline",size:"sm",className:l===i?"bg-dairy-blue":"border-dairy-300",onClick:()=>g(i),children:i},i)}),o>5&&e.jsx("span",{className:"text-dairy-600 px-2",children:"..."}),o>5&&e.jsx(f,{variant:l===o?"default":"outline",size:"sm",className:l===o?"bg-dairy-blue":"border-dairy-300",onClick:()=>g(o),children:o})]}),e.jsx(f,{variant:"outline",size:"sm",className:"border-dairy-300",onClick:()=>g(s=>Math.min(s+1,o)),disabled:l===o,children:"Next"})]})]})]})]})]})]})})};export{Be as default};
